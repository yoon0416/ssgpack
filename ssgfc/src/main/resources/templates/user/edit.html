<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head>
<title>ë‚´ ì •ë³´ ìˆ˜ì •</title>
<style>
.profile-preview {
	width: 100px;
	height: 100px;
	border-radius: 50%;
	object-fit: cover;
	border: 1px solid #ccc;
	margin-bottom: 10px;
}
</style>
</head>
<body>
<!-- âœ… jQuery ì¶”ê°€ -->


<th:block layout:fragment="content">
	<div class="container mt-5" style="max-width: 600px;">
		<h2 class="mb-4">ë‚´ ì •ë³´ ìˆ˜ì •</h2>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

		<form method="post" th:action="@{/user/mypage/edit}" enctype="multipart/form-data">
			<!-- ì´ë©”ì¼ -->
			<div class="mb-3">
				<label for="email" class="form-label">ì´ë©”ì¼</label>
				<input type="email" id="email" name="email" class="form-control" th:value="${user.email}" required>
			</div>

			<!-- ë‹‰ë„¤ì„ -->
			<div class="mb-3">
				<label for="nick_name" class="form-label">ë‹‰ë„¤ì„</label>
				<input type="text" id="nick_name" name="nick_name" class="form-control" th:value="${user.nick_name}" required>
			</div>

			<!-- ì†Œê°œê¸€ -->
			<div class="mb-3">
				<label for="introduce" class="form-label">ì†Œê°œê¸€</label>
				<textarea id="introduce" name="introduce" class="form-control" rows="4" th:text="${user.introduce}">ìê¸°ì†Œê°œ ì…ë ¥</textarea>
			</div>

			<!-- ìš°í¸ë²ˆí˜¸ -->
			<div class="mb-3">
				<label for="zipcode" class="form-label">ìš°í¸ë²ˆí˜¸</label>
				<input type="text" id="zipcode" name="zipcode" class="form-control" th:value="${user.zipcode}" readonly onclick="execDaumPostcode()">
			</div>

			<!-- ê¸°ë³¸ ì£¼ì†Œ -->
			<div class="mb-3">
				<label for="address" class="form-label">ì£¼ì†Œ</label>
				<input type="text" id="address" name="address" class="form-control" th:value="${user.address}" readonly onclick="execDaumPostcode()">
			</div>

			<!-- ìƒì„¸ ì£¼ì†Œ -->
			<div class="mb-3">
				<label for="addressDetail" class="form-label">ìƒì„¸ì£¼ì†Œ</label>
				<input type="text" id="addressDetail" name="addressDetail" class="form-control" th:value="${user.addressDetail}">
			</div>

			<!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
			<div class="mb-3">
				<label class="form-label">í”„ë¡œí•„ ì´ë¯¸ì§€</label><br>
				<img th:if="${user.profile_img != null}" th:src="@{'/images/userimage/' + ${user.profile_img}}" alt="í”„ì‚¬ ë¯¸ë¦¬ë³´ê¸°" class="profile-preview" id="profilePreview">
				<img th:if="${user.profile_img == null}" src="/default-profile.png" alt="ê¸°ë³¸ í”„ì‚¬" class="profile-preview" id="profilePreview">
				<input type="file" name="file" class="form-control mt-2" accept="image/*" onchange="previewProfile(event)">
			</div>

			<!-- ğŸ“± ì „í™”ë²ˆí˜¸ + ì¸ì¦ìš”ì²­ -->
			<div class="mb-3">
				<label for="phone" class="form-label">ì „í™”ë²ˆí˜¸</label>
				<div class="input-group">
					<input type="text" id="phone" name="phone" class="form-control" placeholder="'-' ì—†ì´ ì…ë ¥">
					<button type="button" class="btn btn-outline-primary" onclick="sendCode()">ì¸ì¦ìš”ì²­</button>
				</div>
			</div>

			<!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
			<div class="mb-3" id="authCodeBox" style="display: none;">
				<label for="authCode" class="form-label">ì¸ì¦ë²ˆí˜¸</label>
				<div class="input-group">
					<input type="text" id="authCode" class="form-control" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥">
					<button type="button" class="btn btn-outline-success" onclick="verifyCode()">í™•ì¸</button>
				</div>
				<div id="authResult" class="form-text text-danger mt-1"></div>
			</div>

			<!-- í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ -->
			<div class="mb-3">
				<label for="currentPwd" class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
				<input type="password" id="currentPwd" name="currentPwd" class="form-control" required autocomplete="current-password">
			</div>

			<!-- ë²„íŠ¼ -->
			<div class="text-end">
				<a th:href="@{/user/mypage}" class="btn btn-secondary">ì·¨ì†Œ</a>
				<button type="submit" class="btn btn-primary" id="saveBtn" disabled>ì €ì¥</button>
			</div>
		</form>

		<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë²„íŠ¼ -->
		<div class="text-end mt-2">
			<a th:href="@{/user/password/change}" class="btn btn-outline-warning">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
		</div>

		<!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
		<div th:if="${errorMessage}" class="alert alert-danger mt-3">
			<p th:text="${errorMessage}">ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ</p>
		</div>

		<!-- ì„±ê³µ ë©”ì‹œì§€ -->
		<div th:if="${param.updated}" class="alert alert-success mt-3">
			<p>ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
		</div>
	</div>

	<!-- ì£¼ì†Œ ê²€ìƒ‰ API -->
	<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script>
	function execDaumPostcode() {
		new daum.Postcode({
			oncomplete: function(data) {
				document.getElementById("zipcode").value = data.zonecode;
				document.getElementById("address").value = data.roadAddress || data.jibunAddress;
				document.getElementById("addressDetail").focus();
			}
		}).open();
	}
	</script>

	<!-- í”„ì‚¬ ë¯¸ë¦¬ë³´ê¸° -->
	<script>
	function previewProfile(event) {
		const preview = document.getElementById("profilePreview");
		const file = event.target.files[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = e => preview.src = e.target.result;
			reader.readAsDataURL(file);
		}
	}
	</script>

	<!-- ì „í™”ë²ˆí˜¸ ì¸ì¦ ë¡œì§ -->
	<script>
	let serverCode = "";

	function sendCode() {
		const phone = document.getElementById("phone").value;
		if (!phone || phone.length < 10) {
			alert("ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			return;
		}
		$.ajax({
			url: "/phone/send",
			type: "get",
			data: { to: phone },
			success: function(code) {
				serverCode = code;
				$("#authCodeBox").show();
				$("#authResult").text("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.").removeClass("text-danger").addClass("text-success");
			},
			error: function() {
				alert("ì¸ì¦ë²ˆí˜¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
			}
		});
	}

	function verifyCode() {
		const input = document.getElementById("authCode").value;
		if (input === serverCode) {
			$("#authResult").text("ì¸ì¦ ì„±ê³µ âœ…").removeClass("text-danger").addClass("text-success");
			document.getElementById("saveBtn").disabled = false;
		} else {
			$("#authResult").text("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.").removeClass("text-success").addClass("text-danger");
			document.getElementById("saveBtn").disabled = true;
		}
	}
	</script>
</th:block>
</body>
</html>
