<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
    <title>야구장 날씨 지도</title>
    <link rel="stylesheet" th:href="@{/css/weather.css}" />
    <style>
        #kbo-map-container {
            position: relative;
            width: 700px;
            height: auto;
        }

        #korea-map {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .circle-marker {
            position: absolute;
            width: 28px;
            height: 28px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 28px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #stadium-info-panel {
            flex: 0.6;
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 300px;
            box-shadow: 0 0 8px rgba(0,0,0,0.05);
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container d-flex gap-4 py-4">
        <!-- 지도 영역 -->
        <div id="kbo-map-container">
            <img src="/images/map/map.png" alt="KBO 지도" id="korea-map"/>
        </div>

        <!-- 오른쪽 정보 패널 -->
        <div id="stadium-info-panel">
            <h3>경기장을 클릭!</h3>
        </div>
    </div>
</div>

<!-- 스크립트 -->
<div layout:fragment="script">
<script>
    Promise.all([
        fetch("/games").then(res => res.json()),
        fetch("/api/locations").then(res => res.json())
    ]).then(([games, locations]) => {

        const container = document.getElementById("kbo-map-container");

        locations.forEach(location => {
            const marker = document.createElement("div");
            marker.className = "circle-marker";
            marker.textContent = location.shortName; // 문학, 잠실 등
            marker.style.left = location.leftPercent;
            marker.style.top = location.topPercent;
            marker.style.backgroundColor = "black"; // 기본 검정

            marker.addEventListener("click", () => {
            	const matchedGames = games.filter(game => {
            	    const gameDate = new Date(game.gameDate);
            	    const today = new Date();
            	    today.setHours(0, 0, 0, 0); // 오늘 00시 기준

            	    return game.location === location.stadiumName && gameDate >= today;
            	});

                const infoBox = document.getElementById("stadium-info-panel");

                if (matchedGames.length > 0) {
                    let html = `<h3>${location.stadiumName}</h3>`;
                    matchedGames.forEach(game => {
                        const opponent = game.team1 === 'SSG' ? game.team2 : game.team1;
                        html += `<p>${game.gameDate} vs ${opponent}</p>`;
                        if (game.weather) {
                            html += `<p>날씨: ${game.weather}</p>`;
                        }
                    });
                    infoBox.innerHTML = html;
                } else {
                    infoBox.innerHTML = `
                        <h3>${location.stadiumName}</h3>
                        <p>향후 SSG 일정이 없습니다.</p>
                    `;
                }
            });

            container.appendChild(marker);
        });
    });
</script>
</div>
</body>
</html>
