<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
    <title>ì•¼êµ¬ì¥ ë‚ ì”¨ ì§€ë„</title>
    <link rel="stylesheet" th:href="@{/css/weather.css}" />
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Honk&display=swap" rel="stylesheet">
    <style>
        #kbo-map-container {
            position: relative;
            width: 700px;
            height: auto;
        }

        #korea-map {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .circle-marker {
            position: absolute;
            width: 28px;
            height: 28px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 28px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #stadium-info-panel {
            flex: 0.6;
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 300px;
            box-shadow: 0 0 8px rgba(0,0,0,0.05);
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container d-flex gap-4 py-4">
        <!-- ì§€ë„ ì˜ì—­ -->
        <div id="kbo-map-container">
            <img src="/images/map/map.png" alt="KBO ì§€ë„" id="korea-map"/>
            <div id="radar-icon">
        <img src="images/emojis/radar_loop2.gif" id="radar-img" alt="Radar Icon" />
    </div>
        </div>
        
<script>
document.getElementById("radar-icon").addEventListener("mouseenter", () => {
  const radar = document.getElementById("radar-img");
  const src = radar.src;        // í˜„ì¬ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì €ì¥
  radar.src = "";               // ë¨¼ì € ë¹„ì›Œì„œ ì´ë¯¸ì§€ ì´ˆê¸°í™”
  radar.src = src;              // ë‹¤ì‹œ ê°™ì€ ê²½ë¡œë¡œ ì¬ì„¤ì • â†’ ì¬ìƒ ì‹œì‘
});
</script>

        <!-- ì˜¤ë¥¸ìª½ ì •ë³´ íŒ¨ë„ -->
        <div id="stadium-info-panel" style="flex: 1; width: 100%; max-width: none;">
            <h3>ê²½ê¸°ì¥ì„ í´ë¦­!</h3>
        </div>
    </div>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<div layout:fragment="script">
<script>
Promise.all([
    fetch("/api/today-games").then(res => res.json()),
    fetch("/api/locations").then(res => res.json())
]).then(([todayGames, locations]) => {
    const container = document.getElementById("kbo-map-container");

    locations.forEach(location => {
        const marker = document.createElement("div");
        marker.className = "circle-marker";
        marker.textContent = location.shortName;
        marker.style.left = location.leftPercent;
        marker.style.top = location.topPercent;
        marker.dataset.team = location.teamKey;

        const isTodayGame = todayGames.some(game => game.stadium === location.stadiumName);
        marker.style.backgroundColor = isTodayGame ? "red" : "black";

        marker.addEventListener("click", async () => {
            // ë§ˆì»¤ì˜ ìœ„ì¹˜ì™€ í¬ê¸° ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const rect = marker.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            // ë¬¼ê²° ìš”ì†Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            const ripple = document.createElement("div");
            ripple.className = "ripple-effect";
            
            ripple.style.backgroundColor = isTodayGame
            ? "rgba(255, 0, 0, 0.8)"   //  ë¶‰ì€ íŒŒë™
            : "rgba(0, 0, 0, 0.6)";   //  íšŒìƒ‰ íŒŒë™

            // ë¬¼ê²° ìš”ì†Œì˜ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ì˜ ì¤‘ì‹¬ì— ë§ì¶¥ë‹ˆë‹¤.
            ripple.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
            ripple.style.top = `${rect.top - containerRect.top + rect.height / 2}px`;

            // ë¬¼ê²° ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€í•©ë‹ˆë‹¤.
            container.appendChild(ripple);

            // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ ë¬¼ê²° ìš”ì†Œë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            setTimeout(() => ripple.remove(), 1200);

            // ê²½ê¸°ì¥ ì •ë³´ íŒ¨ë„ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            const infoBox = document.getElementById("stadium-info-panel");

            // ğŸ“Œ 1. ë¨¼ì € ë‚ ì”¨ API í˜¸ì¶œ (í•­ìƒ ë‚ ì”¨ëŠ” ë³´ì—¬ì•¼ í•˜ë‹ˆê¹Œ)
            const teamKey = marker.dataset.team;
            let weather = {};
            try {
                const weatherRes = await fetch(`/api/weather/${teamKey}`);
                weather = await weatherRes.json();
            } catch (error) {
                console.error("ë‚ ì”¨ API í˜¸ì¶œ ì‹¤íŒ¨", error);
            }

            let html = `<h3>${location.stadiumName}</h3>`;

            if (isTodayGame) {
                //  ì˜¤ëŠ˜ ê²½ê¸° ìˆìŒ
                const matchedGames = todayGames.filter(game => game.stadium === location.stadiumName);
                matchedGames.forEach(game => {
                	html += `<p>ì˜¤ëŠ˜ ê²½ê¸°: vs ${game.team}</p>`;
                });
            } else {
                //  ì˜¤ëŠ˜ ê²½ê¸° ì—†ìŒ
                try {
                    const allGamesRes = await fetch("/games");
                    const allGames = await allGamesRes.json();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const matchedFutureGames = allGames.filter(game => {
                        const gameDate = new Date(game.gameDate);
                        return (game.location === location.stadiumName) &&
                               (gameDate >= today) &&
                               (game.team1 === 'SSG' || game.team2 === 'SSG');
                    });

                    if (matchedFutureGames.length > 0) {
                        matchedFutureGames.forEach(game => {
                            const opponent = game.team1 === 'SSG' ? game.team2 : game.team1;
                            html += `<p>ì˜ˆì • ê²½ê¸°: ${game.gameDate} vs ${opponent}</p>`;
                        });
                    } else {
                        html += `<p>í–¥í›„ SSG ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                } catch (error) {
                    console.error("ê²½ê¸° ì¼ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                    html += `<p>í–¥í›„ ê²½ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
            }

            // í•­ìƒ ë‚ ì”¨ ì¶œë ¥
            if (weather.weather && weather.temp) {
    const iconPath = `/images/emojis/${weather.weathericon}`;
    html += `
        <div style="text-align: center; margin: 16px 0;">
            <img src="${iconPath}" alt="${weather.weather}" width="300" height="300" style="display: block; margin: 0 auto;">
        </div>
        <p style="text-align: center;">${weather.weather} / ${weather.temp}</p>
    `;
} else {
    html += `<p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
}

            infoBox.innerHTML = html;
        });

        container.appendChild(marker);
    });
});
</script>
</div>
</body>
</html>