<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>ê¸€ ìƒì„¸ë³´ê¸°</title>
    <link rel="stylesheet" href="/css/view.css" />
</head>
<body>

<th:block layout:fragment="content">

    <div class="container mt-5">

        <h2 class="mb-4">
            <span th:text="${board.title}"></span>
            <!-- âœ… ê°ì • ë¶„ì„ ê²°ê³¼ì— ë”°ë¥¸ ì´ëª¨ì§€ í‘œì‹œ -->
            <span th:if="${board.emotion == 'POSITIVE'}">ğŸ˜€</span>
            <span th:if="${board.emotion == 'NEGATIVE'}">ğŸ˜¡</span>
            <span th:if="${board.emotion == 'NEUTRAL'}">ğŸ˜</span>
        </h2>

        <!-- âœ… ì‘ì„±ì ë° ê²Œì‹œê¸€ ì •ë³´ -->
        <div class="mb-3 text-muted">
            <span>ì‘ì„±ì:
                <b th:if="${board.user != null}"
                   th:text="${board.user.nick_name}"
                   th:onclick="|openUserPopup(${board.user.id})|"
                   style="cursor: pointer; color: #0d6efd; text-decoration: underline;">
                </b>
                <b th:if="${board.user == null}">ìµëª…</b>
            </span>
            <span class="ms-3">ì‘ì„±ì¼: <span th:text="${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}"></span></span>
            <span class="ms-3">ì¡°íšŒìˆ˜: <span th:text="${board.hit}">0</span></span>
        </div>

        <!-- âœ… ê²Œì‹œê¸€ ì´ë¯¸ì§€ -->
        <div th:if="${board.img != null}">
            <img th:src="@{'/images/board/' + ${board.img}}" alt="ì´ë¯¸ì§€" class="img-fluid mb-4">
        </div>

        <!-- âœ… ê²Œì‹œê¸€ ë³¸ë¬¸ ë‚´ìš© -->
        <div class="mb-4 border p-3" style="min-height: 150px;" 
            th:text="${board.content}" 
            th:classappend="
                ${board.emotion == 'POSITIVE'} ? 'positive-bg' :
                (${board.emotion == 'NEGATIVE'} ? 'negative-bg' : 'neutral-bg')
            ">ë‚´ìš©</div>

        <!-- âœ… ì¢‹ì•„ìš” ê¸°ëŠ¥ -->
        <div class="mb-3">
            <form th:action="@{'/board/' + ${board.id} + '/like'}" method="post">
                <button type="submit" th:classappend="${liked} ? 'btn btn-danger' : 'btn btn-outline-danger'">
                    <span th:text="${liked} ? 'â™¥ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'â™¡ ì¢‹ì•„ìš”'"></span>
                </button>
                <span class="ms-2 text-muted">ì´ <span th:text="${likeCount}">0</span>ëª…</span>
            </form>
        </div>

        <!-- âœ… ì‘ì„±ì í”„ë¡œí•„ ì¹´ë“œ -->
        <div class="card mb-4 p-3" style="max-width: 100%; margin: 20px auto;">
            <div class="d-flex align-items-center">
                <div class="text-center me-4">
                    <img th:src="${board.user != null and board.user.profile_img != null} ? @{'/images/userimage/' + ${board.user.profile_img}} : '/images/userimage/default-profile.png'"
                         alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                         style="width:100px; height:100px; object-fit:cover; border-radius:50%; cursor:pointer;"
                         th:onclick="|openUserPopup(${board.user.id})|">
                    <h6 class="mt-2"
                        th:text="${board.user != null ? board.user.nick_name : 'ì•Œ ìˆ˜ ì—†ìŒ'}"
                        th:onclick="|openUserPopup(${board.user.id})|"
                        style="cursor: pointer; color: #0d6efd; text-decoration: underline;"></h6>
                </div>
                <div class="flex-grow-1 border rounded p-3" style="min-height:100px;">
                    <p class="mb-0" th:text="${board.user != null && board.user.introduce != null ? board.user.introduce : 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.'}"
                       style="font-size: 0.9rem; color: #666;"></p>
                </div>
            </div>
        </div>

        <!-- âœ… ëŒ“ê¸€ ì‘ì„± í¼ (í•­ìƒ ê³ ì •) -->
        <div class="comment-form mt-5" sec:authorize="isAuthenticated()">
            <form th:action="@{'/board/' + ${board.id} + '/comment/add'}" method="post">
                <input type="hidden" name="parentId" value="" />
                <textarea name="content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button type="submit" class="btn btn-primary mt-2">ëŒ“ê¸€ ì‘ì„±</button>
            </form>
        </div>

        <!-- âœ… ëŒ“ê¸€ ëª©ë¡ -->
        <div class="comment-list mt-4">
            <h5>ëŒ“ê¸€</h5>
            <div th:each="comment : ${board.comments}" th:if="${comment.parent == null}">
                <div th:replace="~{board/comment :: commentFragment(${comment}, 0)}"></div>
            </div>
        </div>

        <!-- âœ… ëª©ë¡/ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
        <div class="d-flex justify-content-between mt-4">
            <a th:href="@{/board/list}" class="btn btn-secondary">ëª©ë¡</a>
            <div th:if="${currentUserId != null and currentUserId == board.user.id}">
                <a th:href="@{'/board/edit/' + ${board.id}}" class="btn btn-outline-primary">ìˆ˜ì •</a>
                <a th:href="@{'/board/delete/' + ${board.id}}" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="btn btn-outline-danger">ì‚­ì œ</a>
            </div>
        </div>

    </div>

</th:block>

<!-- âœ… ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="script">
    <script>
    // âœ… í”„ë¡œí•„ íŒì—…
    function openUserPopup(userId) {
        window.open('/popup?userId=' + userId, '_blank', 'width=500,height=700');
    }

    // âœ… ë‹µê¸€ ì…ë ¥ì°½ í† ê¸€
    function toggleReplyForm(commentId) {
        const form = document.getElementById('replyForm-' + commentId);
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'flex'; // ë„“ê²Œ ë³´ì—¬ì¤Œ
        } else {
            form.style.display = 'none';
        }
    }
    </script>
</th:block>

</body>
</html>
