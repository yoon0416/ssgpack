<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{fragments/layout}">
<head>
    <title>글 상세보기</title>
    <link rel="stylesheet" th:href="@{/css/view.css}" />
    
    <!-- ✅ CSRF 메타태그 추가 -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
	<meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
</head>

<body>
<th:block layout:fragment="content">

<div class="container mt-5">

    <!-- ✅ 게시글 제목 + 감정 이모지 -->
    <h2 class="mb-4">
        <span th:text="${board.title}"></span>
        <span th:if="${board.emotion == 'POSITIVE'}">😀</span>
        <span th:if="${board.emotion == 'NEGATIVE'}">😡</span>
        <span th:if="${board.emotion == 'NEUTRAL'}">😐</span>
    </h2>

    <!-- ✅ 작성자/작성일/조회수/신고 버튼 -->
    <div class="mb-3 text-muted">
        <span>작성자:
            <b th:if="${board.user != null}" th:text="${board.user.nick_name}" th:onclick="|openUserPopup(${board.user.id})|" style="cursor:pointer; color:#0d6efd; text-decoration:underline;"></b>
            <b th:if="${board.user == null}">익명</b>
        </span>
        <span class="ms-3">작성일: <span th:text="${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}"></span></span>
        <span class="ms-3">조회수: <span th:text="${board.hit}"></span></span>
        <div sec:authorize="isAuthenticated()">
        	<button type="button" class="btn btn-sm btn-outline-danger ms-2" th:onclick="|openReportModal('BOARD', ${board.id})|">🚨 신고</button>
        </div>
    </div>

    <!-- ✅ 게시글 이미지 -->
    <div th:if="${board.img != null}">
        <img th:src="@{'/images/board/' + ${board.img}}" alt="이미지" class="img-fluid mb-4">
    </div>

    <!-- ✅ 게시글 본문 -->
    <div class="mb-4 border p-3"
         style="min-height:150px;"
         th:text="${board.content}"
         th:classappend="${board.emotion == 'POSITIVE'} ? 'positive-bg' : (${board.emotion == 'NEGATIVE'} ? 'negative-bg' : 'neutral-bg')">
        내용
    </div>

    <!-- ✅ 좋아요 버튼 -->
    <div class="mb-3">
        <form th:action="@{'/board/' + ${board.id} + '/like'}" method="post">
            <button type="submit" th:classappend="${liked} ? 'btn btn-danger' : 'btn btn-outline-danger'">
                <span th:text="${liked} ? '♥ 좋아요 취소' : '♡ 좋아요'"></span>
            </button>
            <span class="ms-2 text-muted">총 <span th:text="${likeCount}"></span>명</span>
        </form>
    </div>
    
    <!-- ✅ 목록/수정/삭제 버튼 -->
    <div class="d-flex justify-content-between mt-4">
        <a th:href="@{/board/list}" class="btn btn-secondary">목록</a>
        <div th:if="${currentUserId != null and currentUserId == board.user.id}">
            <a th:href="@{'/board/edit/' + ${board.id}}" class="btn btn-outline-primary">수정</a>
               <a th:href="@{'/board/delete/' + ${board.id}}" onclick="return confirm('삭제하시겠습니까?')" class="btn btn-outline-danger">삭제</a>
        </div>
    </div>
 
	<!-- ✅ 댓글 작성 폼 (항상 고정) -->
    <div class="comment-form mt-5" sec:authorize="isAuthenticated()">
        <form th:action="@{'/board/' + ${board.id} + '/comment/add'}" method="post">
            <input type="hidden" name="parentId" value="" />
            <textarea name="content" class="form-control" rows="3" placeholder="댓글을 입력하세요"></textarea>
            <button type="submit" class="btn btn-primary mt-2">댓글 작성</button>
        </form>
    </div>
    
    <!-- ✅ 댓글 영역 (분리) -->
    <div th:replace="board/comment :: commentListFragment(${board.comments})"></div>

    <!-- ✅ 신고 모달창 (분리) -->
    <div th:replace="board/reportmodal :: reportModalFragment"></div>

</div>

</th:block>

<th:block layout:fragment="script">
<script th:src="@{/js/view.js}"></script>
</th:block>

</body>
</html>
