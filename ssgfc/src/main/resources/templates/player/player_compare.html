<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>선수 비교</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .compare-section {
      margin-top: 50px;
    }
    .compare-table {
      margin-top: 30px;
    }
  </style>
</head>

<body>

<th:block layout:fragment="content">
  <div class="container compare-section">
    <h2 class="text-center">선수 비교</h2>

    <div class="text-center mb-4">
      <button class="btn btn-outline-primary me-2" onclick="loadPlayers('투수')">투수 비교</button>
      <button class="btn btn-outline-success" onclick="loadPlayers('타자')">타자 비교</button>
    </div>

    <div class="row justify-content-center my-4">
      <div class="col-5">
        <select class="form-select" id="player1">
          <option value="">선수 1 선택</option>
        </select>
      </div>
      <div class="col-5">
        <select class="form-select" id="player2">
          <option value="">선수 2 선택</option>
        </select>
      </div>
    </div>

    <div class="text-center">
      <button class="btn btn-danger" onclick="comparePlayers()">비교하기</button>
    </div>

    <div class="compare-table">
      <table class="table table-bordered text-center">
        <thead>
          <tr>
            <th>스탯</th>
            <th id="player1Name">선수1</th>
            <th id="player2Name">선수2</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>메인 스탯</td>
            <td id="player1Stat">-</td>
            <td id="player2Stat">-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let allPlayers = [];

    window.onload = function() {
      fetch('/api/players')
        .then(response => response.json())
        .then(players => {
          allPlayers = players;
          loadPlayers('투수'); // 처음엔 투수 리스트로 기본 로딩
        });
    };

    function loadPlayers(type) {
      const player1Select = document.getElementById('player1');
      const player2Select = document.getElementById('player2');

      // 기존 옵션 비우기
      player1Select.innerHTML = '<option value="">선수 1 선택</option>';
      player2Select.innerHTML = '<option value="">선수 2 선택</option>';

      const filtered = allPlayers.filter(player => {
        const pos = (player.position || '').toUpperCase();
        if (type === '투수') {
          return pos === '투수' || pos === 'P';
        } else {
          // 타자라면 투수 제외
          return pos !== '투수' && pos !== 'P';
        }
      });

      filtered.forEach(player => {
        const option1 = document.createElement('option');
        option1.value = player.pno;
        option1.textContent = player.name;
        player1Select.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = player.pno;
        option2.textContent = player.name;
        player2Select.appendChild(option2);
      });
    }

    function comparePlayers() {
      const pno1 = document.getElementById('player1').value;
      const pno2 = document.getElementById('player2').value;

      if (!pno1 || !pno2) {
        alert('두 명의 선수를 모두 선택하세요.');
        return;
      }

      Promise.all([
        fetch(`/api/players/${pno1}`).then(res => res.json()),
        fetch(`/api/players/${pno2}`).then(res => res.json())
      ]).then(([player1, player2]) => {
        document.getElementById('player1Name').textContent = player1.name;
        document.getElementById('player2Name').textContent = player2.name;

        const mainStat1 = extractMainStat(player1);
        const mainStat2 = extractMainStat(player2);

        document.getElementById('player1Stat').textContent = mainStat1;
        document.getElementById('player2Stat').textContent = mainStat2;
      });
    }

    function extractMainStat(player) {
      if (!player.stats || player.stats.length === 0) return '-';

      const stat = player.stats[0];
      const statMap = stat.statMap;

      const pos = (statMap['Pos.'] || '').toUpperCase();

      if (pos === 'P') {
        return statMap['WAR'] || '-'; // 투수면 WAR
      } else {
        return statMap['비율'] || '-'; // 타자면 비율
      }
    }
  </script>
</th:block>

</body>
</html>
