<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„ ìˆ˜ ë¹„êµ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .compare-section { margin-top: 50px; }
    .compare-table { margin-top: 30px; }
    .compare-type .active {
      background-color: #0d6efd;
      color: white;
    }
    .chart-container {
      max-width: 1000px;
      margin: 60px auto;
    }
    canvas {
      width: 100% !important;
      height: 500px !important;
    }
    #analysisResult {
      max-width: 1000px;
      margin: 30px auto;
    }
    .vs-label {
      font-size: 1.8rem;
      font-weight: bold;
      color: #dc3545;
    }
  </style>
</head>

<body>

<th:block layout:fragment="content">
  <div class="container compare-section">
    <h2 class="text-center">ì„ ìˆ˜ ë¹„êµ</h2>

    <div class="text-center mb-4 compare-type">
      <button id="pitcherButton" class="btn btn-outline-primary me-2" onclick="loadPlayers('íˆ¬ìˆ˜')">íˆ¬ìˆ˜ ë¹„êµ</button>
      <button id="batterButton" class="btn btn-outline-success" onclick="loadPlayers('íƒ€ì')">íƒ€ì ë¹„êµ</button>
    </div>

    <div class="row justify-content-center my-4">
      <div class="col-5">
        <select class="form-select" id="player1">
          <option value="">ì„ ìˆ˜ 1 ì„ íƒ</option>
        </select>
      </div>
      <div class="col-1 text-center fs-3 fw-bold text-danger" id="vs-label">VS</div>
      <div class="col-5">
        <select class="form-select" id="player2">
          <option value="">ì„ ìˆ˜ 2 ì„ íƒ</option>
        </select>
      </div>
    </div>

    <div class="text-center">
      <button class="btn btn-danger" onclick="comparePlayers()">ë¹„êµí•˜ê¸°</button>
    </div>

    <div class="compare-table">
      <table class="table table-bordered text-center">
        <thead>
          <tr>
            <th>ìŠ¤í…</th>
            <th id="player1Name">ì„ ìˆ˜1</th>
            <th id="player2Name">ì„ ìˆ˜2</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="mainStatName">ì£¼ìš” ìˆ˜ì¹˜</td>
            <td id="player1Stat">-</td>
            <td id="player2Stat">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
    <div id="analysisResult" class="mt-5 p-4 border rounded bg-light">
      <h5 class="mb-3">ğŸ“Š ìë™ ë¶„ì„ ê²°ê³¼</h5>
      <div id="analysisText" class="text-muted">ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ë¹„êµë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
    </div>

    <div class="chart-container">
      <canvas id="compareChart"></canvas>
    </div>
  </div>

  <script>
    let allPlayers = [];
    let currentType = 'íˆ¬ìˆ˜';
    let barChart;

    const statNameMapping = {
      'ERA': 'í‰ê· ìì±…', 'WHIP': 'ì¶œë£¨í—ˆìš©ë¥ ','FIP': 'FIP',
      'WAR': 'ì¶œë£¨ìœ¨', 'AVG': 'ì¥íƒ€ìœ¨', 'HR': 'í™ˆëŸ°',
      'RBI': 'íƒ€ì ', 'SLG': 'ì¥íƒ€ìœ¨', 'ë¹„ìœ¨': 'íƒ€ìœ¨', 'R/ePA': 'ìŠ¹ë¦¬ê¸°ì—¬ë„',
      'OPS': 'ì¢…í•©ê³µê²©ì§€í‘œ', 'dWAR': 'ìˆ˜ë¹„ê¸°ì—¬ë„'
    };

    const getStatLabel = (key, isPitcher) =>
      key === 'WAR' ? (isPitcher ? 'ìŠ¹ë¦¬ê¸°ì—¬ë„' : 'ì¶œë£¨ìœ¨') : (statNameMapping[key] ?? key);

    window.onload = function() {
      fetch('/api/players')
        .then(response => response.json())
        .then(players => {
          allPlayers = players;
          loadPlayers('íˆ¬ìˆ˜');
        });
    };

    function loadPlayers(type) {
      currentType = type;
      const player1Select = document.getElementById('player1');
      const player2Select = document.getElementById('player2');

      document.querySelectorAll('.compare-type button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(type === 'íˆ¬ìˆ˜' ? 'pitcherButton' : 'batterButton').classList.add('active');

      player1Select.innerHTML = '<option value="">ì„ ìˆ˜ 1 ì„ íƒ</option>';
      player2Select.innerHTML = '<option value="">ì„ ìˆ˜ 2 ì„ íƒ</option>';

      const filtered = allPlayers.filter(player => {
        const pos = (player.position || '').toUpperCase();
        return type === 'íˆ¬ìˆ˜' ? (pos === 'íˆ¬ìˆ˜' || pos === 'P') : (pos !== 'íˆ¬ìˆ˜' && pos !== 'P');
      });

      filtered.forEach(player => {
        const option1 = document.createElement('option');
        option1.value = player.pno;
        option1.textContent = player.name;
        player1Select.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = player.pno;
        option2.textContent = player.name;
        player2Select.appendChild(option2);
      });

      document.getElementById('mainStatName').textContent = (type === 'íˆ¬ìˆ˜') ? 'WAR' : 'íƒ€ìœ¨';
    }

    function localizeStats(statMap, isPitcher) {
      const nameMap = {
        'ERA': 'í‰ê· ìì±…', 'WHIP': 'ì¶œë£¨í—ˆìš©ë¥ ', 'FIP': 'FIP',
        'WAR': isPitcher ? 'ìŠ¹ë¦¬ê¸°ì—¬ë„' : 'ì¶œë£¨ìœ¨',
        'AVG': 'íƒ€ìœ¨', 'ë¹„ìœ¨': 'íƒ€ìœ¨',
        'OBP': 'ì¶œë£¨ìœ¨', 'SLG': 'ì¥íƒ€ìœ¨', 'HR': 'í™ˆëŸ°',
        'RBI': 'íƒ€ì ', 'R/ePA': 'ìŠ¹ë¦¬ê¸°ì—¬ë„',
        'OPS': 'ì¢…í•©ê³µê²©ì§€í‘œ', 'dWAR': 'ìˆ˜ë¹„ê¸°ì—¬ë„'
      };

      const localized = {};
      for (const key in statMap) {
        const newKey = nameMap[key] || key;
        localized[newKey] = statMap[key];
      }
      return localized;
    }

    function comparePlayers() {
      const pno1 = document.getElementById('player1').value;
      const pno2 = document.getElementById('player2').value;

      if (!pno1 || !pno2) {
        alert('ë‘ ëª…ì˜ ì„ ìˆ˜ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      Promise.all([
        fetch(`/api/players/${pno1}`).then(res => res.json()),
        fetch(`/api/players/${pno2}`).then(res => res.json())
      ]).then(([player1, player2]) => {
        document.getElementById('player1Name').textContent = player1.name;
        document.getElementById('player2Name').textContent = player2.name;

        const mainStat1 = extractMainStat(player1);
        const mainStat2 = extractMainStat(player2);

        document.getElementById('player1Stat').textContent = mainStat1;
        document.getElementById('player2Stat').textContent = mainStat2;

        drawBarChart(player1, player2);

        const isPitcher = currentType === 'íˆ¬ìˆ˜';
        const playerData = {
          [player1.name]: localizeStats(player1.stats?.[0]?.statMap || {}, isPitcher),
          [player2.name]: localizeStats(player2.stats?.[0]?.statMap || {}, isPitcher)
        };

        const readableStats = Object.entries(playerData).map(([name, stats]) => {
          return Object.entries(stats).map(([k, v]) => `${name}ì˜ ${k}ëŠ” ${v}ì…ë‹ˆë‹¤.`).join("\n");
        }).join("\n\n");

        const gptPrompt = `ì•„ë˜ëŠ” ë‘ KBO ì„ ìˆ˜ì˜ ì£¼ìš” ìŠ¤íƒ¯ì…ë‹ˆë‹¤.\nìŠ¤íƒ¯ëª…ì€ í•œêµ­ì–´ì´ë©°, ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë¹„êµ ë¶„ì„í•´ì¤˜:\n\n${readableStats}`;

        fetch("/api/ai/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: gptPrompt })
        })
        .then(res => res.text())
        .then(result => {
          document.getElementById("analysisText").innerText = result;
        })
        .catch(error => {
          document.getElementById("analysisText").innerText = "âŒ ë¶„ì„ ì‹¤íŒ¨: " + error.message;
        });
      });
    }

    function extractMainStat(player) {
      if (!player.stats || player.stats.length === 0) return '-';
      const statMap = player.stats[0].statMap;
      const pos = (statMap['Pos.'] || '').toUpperCase();
      return pos === 'P' ? (statMap['WAR'] || '-') : (statMap['AVG'] || '-');
    }

    function drawBarChart(player1, player2) {
      const statMap1 = player1.stats?.[0]?.statMap || {};
      const statMap2 = player2.stats?.[0]?.statMap || {};

      const headers = currentType === 'íˆ¬ìˆ˜'
        ? ['ERA', 'WHIP', 'FIP', 'WAR']
        : ['AVG', 'ë¹„ìœ¨', 'WAR', 'R/ePA'];

      const labels = headers.map(key => getStatLabel(key, currentType === 'íˆ¬ìˆ˜'));

      const data1 = headers.map(key => parseFloat(statMap1[key]) || 0);
      const data2 = headers.map(key => parseFloat(statMap2[key]) || 0);

      const ctx = document.getElementById('compareChart').getContext('2d');
      if (barChart) barChart.destroy();

      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: player1.name,
              data: data1,
              backgroundColor: 'rgba(54, 162, 235, 0.7)'
            },
            {
              label: player2.name,
              data: data2,
              backgroundColor: 'rgba(255, 99, 132, 0.7)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: currentType + ' ì£¼ìš” ìŠ¤íƒ¯ ë¹„êµ'
            }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</th:block>

</body>
</html>