<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>선수 비교</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .compare-section { margin-top: 50px; }
    .compare-table { margin-top: 30px; }
    .compare-type .active {
      background-color: #0d6efd;
      color: white;
    }
    .chart-container {
      max-width: 1000px;
      margin: 60px auto;
    }
    canvas {
      width: 100% !important;
      height: 500px !important;
    }
    #analysisResult {
      max-width: 1000px;
      margin: 30px auto;
    }
    .vs-label {
      font-size: 1.8rem;
      font-weight: bold;
      color: #dc3545;
    }
  </style>
</head>

<body>

<th:block layout:fragment="content">
  <div class="container compare-section">
    <h2 class="text-center">선수 비교</h2>

    <div class="text-center mb-4 compare-type">
      <button id="pitcherButton" class="btn btn-outline-primary me-2" onclick="loadPlayers('투수')">투수 비교</button>
      <button id="batterButton" class="btn btn-outline-success" onclick="loadPlayers('타자')">타자 비교</button>
    </div>

    <div class="row justify-content-center my-4">
      <div class="col-5">
        <select class="form-select" id="player1">
          <option value="">선수 1 선택</option>
        </select>
      </div>
      <div class="col-1 text-center fs-3 fw-bold text-danger" id="vs-label">VS</div>
      <div class="col-5">
        <select class="form-select" id="player2">
          <option value="">선수 2 선택</option>
        </select>
      </div>
    </div>

    <div class="text-center">
      <button class="btn btn-danger" onclick="comparePlayers()">비교하기</button>
    </div>

    <div class="compare-table">
      <table class="table table-bordered text-center">
        <thead>
          <tr>
            <th>스텐</th>
            <th id="player1Name">선수1</th>
            <th id="player2Name">선수2</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="mainStatName">주요 수치</td>
            <td id="player1Stat">-</td>
            <td id="player2Stat">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 분석 결과 표시 -->
    <div id="analysisResult" class="mt-5 p-4 border rounded bg-light">
      <h5 class="mb-3">📊 자동 분석 결과</h5>
      <div id="analysisText" class="text-muted">선수를 선택하고 비교를 누르세요.</div>
    </div>

    <div class="chart-container">
      <canvas id="compareChart"></canvas>
    </div>
  </div>

  <script>
    let allPlayers = [];
    let currentType = '투수';
    let barChart;

    const statNameMapping = {
      'ERA': '평균자책', 'WHIP': '출루허용률','FIP': 'FIP',
      'WAR': '출루율', 'AVG': '장타율', 'HR': '홈런',
      'RBI': '타점', 'SLG': '장타율', '비율': '타율', 'R/ePA': '승리기여도',
      'OPS': '종합공격지표', 'dWAR': '수비기여도'
    };

    const getStatLabel = (key, isPitcher) =>
      key === 'WAR' ? (isPitcher ? '승리기여도' : '출루율') : (statNameMapping[key] ?? key);

    window.onload = function() {
      fetch('/api/players')
        .then(response => response.json())
        .then(players => {
          allPlayers = players;
          loadPlayers('투수');
        });
    };

    function loadPlayers(type) {
      currentType = type;
      const player1Select = document.getElementById('player1');
      const player2Select = document.getElementById('player2');

      document.querySelectorAll('.compare-type button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(type === '투수' ? 'pitcherButton' : 'batterButton').classList.add('active');

      player1Select.innerHTML = '<option value="">선수 1 선택</option>';
      player2Select.innerHTML = '<option value="">선수 2 선택</option>';

      const filtered = allPlayers.filter(player => {
        const pos = (player.position || '').toUpperCase();
        return type === '투수' ? (pos === '투수' || pos === 'P') : (pos !== '투수' && pos !== 'P');
      });

      filtered.forEach(player => {
        const option1 = document.createElement('option');
        option1.value = player.pno;
        option1.textContent = player.name;
        player1Select.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = player.pno;
        option2.textContent = player.name;
        player2Select.appendChild(option2);
      });

      document.getElementById('mainStatName').textContent = (type === '투수') ? 'WAR' : '타율';
    }

    function localizeStats(statMap, isPitcher) {
      const nameMap = {
        'ERA': '평균자책', 'WHIP': '출루허용률', 'FIP': 'FIP',
        'WAR': isPitcher ? '승리기여도' : '출루율',
        'AVG': '타율', '비율': '타율',
        'OBP': '출루율', 'SLG': '장타율', 'HR': '홈런',
        'RBI': '타점', 'R/ePA': '승리기여도',
        'OPS': '종합공격지표', 'dWAR': '수비기여도'
      };

      const localized = {};
      for (const key in statMap) {
        const newKey = nameMap[key] || key;
        localized[newKey] = statMap[key];
      }
      return localized;
    }

    function comparePlayers() {
      const pno1 = document.getElementById('player1').value;
      const pno2 = document.getElementById('player2').value;

      if (!pno1 || !pno2) {
        alert('두 명의 선수를 모두 선택하세요.');
        return;
      }

      Promise.all([
        fetch(`/api/players/${pno1}`).then(res => res.json()),
        fetch(`/api/players/${pno2}`).then(res => res.json())
      ]).then(([player1, player2]) => {
        document.getElementById('player1Name').textContent = player1.name;
        document.getElementById('player2Name').textContent = player2.name;

        const mainStat1 = extractMainStat(player1);
        const mainStat2 = extractMainStat(player2);

        document.getElementById('player1Stat').textContent = mainStat1;
        document.getElementById('player2Stat').textContent = mainStat2;

        drawBarChart(player1, player2);

        const isPitcher = currentType === '투수';
        const playerData = {
          [player1.name]: localizeStats(player1.stats?.[0]?.statMap || {}, isPitcher),
          [player2.name]: localizeStats(player2.stats?.[0]?.statMap || {}, isPitcher)
        };

        const readableStats = Object.entries(playerData).map(([name, stats]) => {
          return Object.entries(stats).map(([k, v]) => `${name}의 ${k}는 ${v}입니다.`).join("\n");
        }).join("\n\n");

        const gptPrompt = `아래는 두 KBO 선수의 주요 스탯입니다.\n스탯명은 한국어이며, 그대로 사용해서 자연스럽게 비교 분석해줘:\n\n${readableStats}`;

        fetch("/api/ai/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: gptPrompt })
        })
        .then(res => res.text())
        .then(result => {
          document.getElementById("analysisText").innerText = result;
        })
        .catch(error => {
          document.getElementById("analysisText").innerText = "❌ 분석 실패: " + error.message;
        });
      });
    }

    function extractMainStat(player) {
      if (!player.stats || player.stats.length === 0) return '-';
      const statMap = player.stats[0].statMap;
      const pos = (statMap['Pos.'] || '').toUpperCase();
      return pos === 'P' ? (statMap['WAR'] || '-') : (statMap['AVG'] || '-');
    }

    function drawBarChart(player1, player2) {
      const statMap1 = player1.stats?.[0]?.statMap || {};
      const statMap2 = player2.stats?.[0]?.statMap || {};

      const headers = currentType === '투수'
        ? ['ERA', 'WHIP', 'FIP', 'WAR']
        : ['AVG', '비율', 'WAR', 'R/ePA'];

      const labels = headers.map(key => getStatLabel(key, currentType === '투수'));

      const data1 = headers.map(key => parseFloat(statMap1[key]) || 0);
      const data2 = headers.map(key => parseFloat(statMap2[key]) || 0);

      const ctx = document.getElementById('compareChart').getContext('2d');
      if (barChart) barChart.destroy();

      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: player1.name,
              data: data1,
              backgroundColor: 'rgba(54, 162, 235, 0.7)'
            },
            {
              label: player2.name,
              data: data2,
              backgroundColor: 'rgba(255, 99, 132, 0.7)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: currentType + ' 주요 스탯 비교'
            }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</th:block>

</body>
</html>